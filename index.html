<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>[TITOLO_ARGOMENTO: 3–6 parole, concrete, senza metafore]</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css"/>
<link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&family=Lexend:wght@400;600;700&family=Readex+Pro:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>

<style>
/* =========================================================
   TEMA + BASI ACCESSIBILITÀ
   ========================================================= */
:root{
  --bg:#ffffff; --fg:#1f2328; --muted:#5a5f69;
  --accent:#0b5fff; --accent-weak:#dfe9ff;
  --ok:#176f2c; --danger:#b00020;
  --card:#f6f8fa; --surface:#fff; --surface-weak:#f9fafb; --border:#d0d7de;
  --focus:#ffb100;
  --ff:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
  --font-size:18px; --line:1.7; --content:72ch;
  --radius:14px; --shadow:0 4px 12px rgba(0,0,0,.08);
}
.contrast-high{
  --bg:#000; --fg:#fff; --muted:#cfcfcf;
  --accent:#ffd400; --accent-weak:#3a3000;
  --card:#121212; --surface:#0f0f0f; --surface-weak:#171717; --border:#3a3a3a; --focus:#ff0;
}

/* Base tipografica e focus */
html,body{margin:0;background:var(--bg);color:var(--fg);font-family:var(--ff);font-size:var(--font-size);line-height:var(--line)}
a{color:var(--accent)}
a:focus,button:focus,select:focus,input:focus,summary:focus{outline:3px solid var(--focus);outline-offset:2px}
.visually-hidden{position:absolute!important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
.caps-on #content{text-transform:uppercase;letter-spacing:.04em}

/* Layout generale: main + indice laterale (sticky) */
.app{
  display:grid;
  grid-template-columns: 1fr minmax(220px, 280px);
  gap:1rem;
  min-height:100dvh;
}
@media(max-width:1100px){
  .app{grid-template-columns:1fr}
  .toc{display:none}
}
.main{padding:1rem 1rem 3.5rem}
.toc{
  position:sticky; top:72px; align-self:start;
  background:var(--card); border:1px solid var(--border);
  border-radius:var(--radius); box-shadow:var(--shadow);
  padding:.9rem; margin:1rem 1rem 1rem 0;
}
.toc h2{margin:.2rem 0 .6rem; font-size:1.05rem}
.toc ol{margin:0; padding-left:1rem}
.toc a{ text-decoration:none }

/* Toolbar alta */
.toolbar{
  position:sticky; top:0; z-index:9; background:var(--bg);
  border:1px solid var(--border); border-radius:var(--radius);
  box-shadow:var(--shadow); display:flex; gap:.5rem; flex-wrap:wrap; align-items:center;
  padding:.6rem; margin:1rem; margin-bottom:0.6rem;
}
.toolbar-settings{position:relative;display:flex;align-items:center}
.toolbar-settings-menu{
  position:absolute;top:calc(100% + .4rem);left:0;
  transform:translateX(.2rem);
  background:var(--surface);border:1px solid var(--border);border-radius:12px;
  box-shadow:var(--shadow);padding:.4rem;display:flex;flex-direction:column;gap:.3rem;
  min-width:220px;z-index:20;
}
.toolbar-settings-menu[hidden],
.toolbar-settings-menu[data-open="false"]{display:none}
.toolbar-settings-menu[data-open="true"]{display:flex}
.toolbar-settings-menu .btn{width:100%;justify-content:flex-start}
.toolbar-settings-menu .btn:focus{outline:3px solid var(--focus);outline-offset:2px}
.toolbar-settings-menu .legend-hint{
  border-top:1px solid var(--border);
  margin-top:.4rem;
  padding-top:.4rem;
  font-size:.85rem;
  color:var(--muted);
  display:flex;
  flex-direction:column;
  gap:.35rem;
}
.toolbar-settings-menu .legend-hint ul{
  margin:0;
  padding-left:1.1rem;
  display:flex;
  flex-direction:column;
  gap:.25rem;
}
.toolbar-settings-menu .legend-hint li{list-style:disc}
.toolbar .sep{width:1px;height:28px;background:var(--border)}
.btn{border:1px solid var(--border); background:var(--card); color:var(--fg);
     border-radius:10px; padding:.45rem .7rem; display:inline-flex; gap:.4rem; align-items:center; cursor:pointer}
.btn:active{box-shadow: inset 0 0 0 9999px rgba(0,0,0,.06)}
/* Toggle persistenti evidenziati */
.tbtn[aria-pressed="true"]{
  background:var(--accent-weak); border-color:var(--accent);
  box-shadow: inset 0 0 0 2px var(--accent-weak);
}
/* In alto contrasto, rendi le icone chiare */
.contrast-high .toolbar .btn{background:#1a1a1a;border-color:#444;color:#fff}
.contrast-high .toolbar .btn i{color:#fff}
.state-pill{background:var(--accent-weak);border:1px solid var(--border);border-radius:999px;padding:.2rem .5rem;font-size:.85rem}

/* Contenuti */
.mode-simplified .estesa{display:none}
body:not(.mode-simplified) .semplificata{display:none}
.content{max-width:var(--content);margin:0 auto}
.content h1{
  font-size:1.9rem;margin:.2rem 0 .8rem;display:flex;gap:.6rem;align-items:flex-start;
  /* wrap sicuro: non oltrepassa il fianco destro */
  flex-wrap:wrap; word-break:break-word; overflow-wrap:anywhere;
}
.content h2{font-size:1.35rem;margin:1.2rem 0 .6rem;display:flex;gap:.5rem;align-items:center}
.content p{margin:.6rem 0}
.prestart{margin:.8rem 0 0}
.prestart-title{margin:.2rem 0 0}
.prestart-body{margin:.4rem 0 0}
.prestart-body ul,.prestart-body ol{margin:.4rem 0 0 1.2rem;padding-left:1.1rem}
.prestart-body li{margin:.3rem 0}
.card{border:1px solid var(--border);background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:1rem;margin:1rem 0}
.notice{border-left:6px solid var(--accent);background:var(--accent-weak);padding:.8rem 1rem;border-radius:6px}

/* Immagine di contesto */
#immagine figure{margin:0}
#immagine figure:not(.is-svg) img{width:100%;height:auto;max-height:clamp(220px,45vh,360px);object-fit:cover;border-radius:12px}
#immagine figure.is-svg{background:var(--surface);border-radius:12px;padding:1rem;display:flex;flex-direction:column;gap:.6rem;align-items:stretch}
#immagine figure.is-svg img{display:block;width:auto;max-width:100%;height:auto;max-height:clamp(220px,55vh,420px);object-fit:contain;border-radius:10px;margin:0 auto}
#immagine figure[data-has-inline-svg="true"]{gap:1rem}
#immagine figure [data-role="inline-svg"]{border:1px solid var(--border);border-radius:10px;padding:1rem;background:var(--surface);overflow:auto}
#immagine figure [data-role="inline-svg"][hidden]{display:none!important}
#immagine figure [data-role="inline-svg"] svg{width:100%;height:auto}
#immagine figcaption{width:100%;display:flex;flex-direction:column;gap:.25rem;font-size:.95rem}
#immagine figcaption [data-role="credit-wrapper"]{display:inline-flex;flex-wrap:wrap;gap:.25rem;align-items:baseline}
#immagine figcaption a{font-size:.9rem;word-break:break-word}

/* Blocchi concetto */
.concept{display:flex;align-items:flex-start;gap:.8rem;margin:.7rem 0}
.concept-icon{width:46px;min-width:46px;height:46px;display:flex;align-items:center;justify-content:center;border-radius:10px;background:var(--accent-weak);color:var(--fg)}
.concept-text{flex:1}

/* Barra progresso lettura + righello */
.read-progress{position:fixed;inset:0 0 auto 0;height:6px;background:var(--accent-weak);z-index:9999}
.read-progress>div{height:100%;width:0;background:var(--accent);transition:width .12s linear}
.reading-ruler{position:fixed;left:0;right:0;height:2.2em;background:rgba(255,230,120,.28);pointer-events:none;transform:translateY(-9999px);z-index:5}

/* Karaoke: evidenzia parola letta */
.karaoke .word.active{background:#fff3bf;box-shadow:0 0 0 2px #ffe08a inset;border-radius:4px}
.contrast-high .karaoke .word.active{background:#5a4a00;box-shadow:0 0 0 2px #8a7200 inset;color:#fff}

/* Parole chiave: pills + popover */
.kw-list{display:flex;flex-wrap:wrap;gap:.3rem}
.kw-pill{font-size:.85rem;padding:.2rem .5rem;border-radius:999px;border:1px solid var(--border);background:var(--surface);cursor:pointer}
.kw-word{outline-offset:2px;border-bottom:2px dotted rgba(0,0,0,.25); cursor:pointer}
.kw-pop{position:fixed;z-index:9998;max-width:440px;background:#111;color:#fff;border:1px solid #2b2b2b;border-radius:10px;padding:.75rem}
.kw-pop .t{font-weight:700;margin:0 0 .4rem}
.kw-pop .x{position:absolute;top:6px;right:8px;background:#222;color:#fff;border:1px solid #444;border-radius:6px;padding:.1rem .35rem;cursor:pointer}

/* STEP/PROGRESSO (solo indicatore Passo X/Y in toolbar) */
.stepper{display:flex;gap:.4rem;flex-wrap:wrap;align-items:center}
.stepper .dot{width:10px;height:10px;border-radius:50%;background:#cbd5e1;border:1px solid var(--border)}
.stepper .dot.active{background:var(--accent)}
.stepper .label{font-size:.9rem}

/* MICRO-ATTIVAZIONE */
.microqa .item{border:1px dashed var(--border);background:var(--surface);border-radius:12px;padding:.8rem;margin:.6rem 0}
.microqa .choices{display:flex;gap:.6rem;flex-wrap:wrap}
.microqa .choices button{border:1px solid var(--border);background:var(--card);border-radius:10px;padding:.35rem .6rem}

/* QUIZ UNICO */
.quiz-item{display:none;margin:1rem 0}
.quiz-item.active{display:block}
.choice-list{list-style:none;margin:.8rem 0;padding:0;display:grid;gap:.6rem}
.choice{border:2px solid var(--border);background:var(--surface);border-radius:12px;padding:.8rem 1rem;cursor:pointer}
.choice.correct{border-color:var(--ok);background:#eaf6ed}
.choice.wrong{border-color:var(--danger);background:#fde7ea}
.feedback{margin-top:.6rem}
.feedback .good{color:var(--ok);font-weight:700}
.feedback .learn{border-left:4px solid var(--accent);background:var(--accent-weak);padding:.6rem .8rem;border-radius:8px}

/* Mermaid */
.mermaid-wrap{border:1px solid var(--border);background:var(--card);border-radius:var(--radius);padding:1rem;overflow:auto}
.mermaid{min-width:520px}

/* Dialog import JSON */
#importDialog{border:1px solid var(--border);border-radius:var(--radius);padding:1.2rem;background:var(--surface);color:var(--fg);box-shadow:var(--shadow);width:min(560px,90vw)}
#importDialog::backdrop{background:rgba(15,23,42,.35)}
#importDialog h2{margin-top:0;font-size:1.3rem}
#importDialog textarea{width:100%;min-height:200px;margin-top:.6rem;font-family:monospace;font-size:1rem;line-height:1.5;border:1px solid var(--border);border-radius:10px;padding:.6rem;background:var(--surface-weak);color:inherit}
#importDialog textarea:focus{outline:3px solid var(--focus);outline-offset:2px}
#importDialog .actions{display:flex;gap:.6rem;justify-content:flex-end;margin-top:1rem}
#importDialog .actions button{padding:.45rem .9rem;border-radius:10px;border:1px solid var(--border);background:var(--card);cursor:pointer}
#importDialog .actions button.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
#importDialog .error{color:var(--danger);margin-top:.6rem}

/* STAMPA */
@media print{
  .toolbar,.read-progress,.reading-ruler,.kw-pop,#quizControls{display:none!important}
  .main{padding:0!important}
  .content{max-width:100%!important}
  .mermaid{min-width:auto!important}
  .quiz-item{display:block!important}
  .choice.correct,.choice.wrong{border-color:#bbb!important;background:#fff!important}
  .feedback{display:none!important}
  a[href]::after{content:""!important}
  @page{margin:12mm}
}

/* RESPONSIVE */
@media(max-width:900px){
  .main{padding:.6rem .8rem 3rem}
  .mermaid{min-width:360px}
}
</style>
</head>
<body>
<!-- Barra progresso e righello -->
<div class="read-progress" aria-hidden="true"><div></div></div>
<div id="readingRuler" class="reading-ruler" aria-hidden="true"></div>

<a href="#main" class="visually-hidden">Salta al contenuto principale</a>

<!-- TOOLBAR -->
<div class="toolbar" role="toolbar">
  <div class="toolbar-settings">
    <button id="tbSettings" class="btn ebtn" title="[TOOLTIP_SETTINGS]" aria-label="Impostazioni">
      <i class="fa-solid fa-gear"></i>
    </button>
    <div id="tbSettingsMenu" class="toolbar-settings-menu" role="menu" data-open="false" hidden>
      <button id="tbImport" class="btn ebtn" role="menuitem" title="[TOOLTIP_IMPORTA]">
        <i class="fa-solid fa-file-import"></i><span>Importa</span>
      </button>
      <button id="tbPasteImport" class="btn ebtn" role="menuitem" title="[TOOLTIP_INCOLLA]">
        <i class="fa-solid fa-paste"></i><span>Incolla contenuti</span>
      </button>
      <button id="tbExport" class="btn ebtn" role="menuitem" title="[TOOLTIP_ESPORTA]">
        <i class="fa-solid fa-file-export"></i><span>Esporta</span>
      </button>
      <button id="tbDownloadTemplate" class="btn ebtn" role="menuitem" title="[TOOLTIP_SCARICA_MODELLO]">
        <i class="fa-solid fa-download"></i><span>Scarica modello JSON</span>
      </button>
      <button id="tbDownloadSvgDemo" class="btn ebtn" role="menuitem" title="[TOOLTIP_SCARICA_DEMO_SVG]">
        <i class="fa-solid fa-vector-square"></i><span>Scarica demo SVG</span>
      </button>
      <div class="legend-hint" role="group" aria-labelledby="legendHintTitle">
        <p id="legendHintTitle"><strong><i class="fa-solid fa-map"></i> Legenda icone</strong></p>
        <ul>
          <li><i class="fa-solid fa-key"></i> Parola chiave • <i class="fa-solid fa-lightbulb"></i> Suggerimento • <i class="fa-solid fa-triangle-exclamation"></i> Avviso</li>
          <li><i class="fa-solid fa-book-open"></i> Definizione • <i class="fa-solid fa-image"></i> Esempio • <i class="fa-solid fa-ban"></i> Controesempio</li>
        </ul>
      </div>
    </div>
  </div>
  <!-- Tipografia/impaginazione (azioni non persistenti) -->
  <button id="tbFontMinus" class="btn ebtn" title="A−"><i class="fa-solid fa-magnifying-glass-minus"></i></button>
  <button id="tbFontPlus"  class="btn ebtn" title="A+"><i class="fa-solid fa-magnifying-glass-plus"></i></button>
  <button id="tbSpacing"   class="btn ebtn" title="Spaziatura"><i class="fa-solid fa-arrows-up-down"></i></button>
  <button id="tbWidth"     class="btn ebtn" title="Larghezza"><i class="fa-solid fa-arrows-left-right"></i></button>
  <button id="tbBg"        class="btn ebtn" title="Sfondo (ciclo)"><i class="fa-solid fa-paint-roller"></i></button>
  <button id="tbFontCycle" class="btn ebtn" title="Font inclusivi"><i class="fa-solid fa-font"></i></button>
  <span class="sep"></span>
  <!-- Toggle persistenti -->
  <button id="tbContrast"  class="btn tbtn" aria-pressed="false" title="Contrasto alto"><i class="fa-solid fa-circle-half-stroke"></i></button>
  <button id="tbCaps"      class="btn tbtn" aria-pressed="false" title="MAIUSCOLO"><i class="fa-solid fa-a"></i></button>
  <button id="tbRuler"     class="btn tbtn" aria-pressed="false" title="Righello (R)"><i class="fa-solid fa-ruler-horizontal"></i></button>
  <button id="tbSimplify"  class="btn tbtn" aria-pressed="false" title="Semplifica (S)"><i class="fa-solid fa-wand-magic-sparkles"></i></button>
  <button id="tbKaraoke"   class="btn tbtn" aria-pressed="false" title="Karaoke One-Click (K)"><i class="fa-solid fa-highlighter"></i></button>
  <span class="sep"></span>
  <!-- TTS: Leggi (senza karaoke), Pausa, Stop + Voce + Velocità -->
  <button id="tbSpeak" class="btn ebtn" title="Leggi senza karaoke"><i class="fa-solid fa-volume-high"></i> Leggi</button>
  <button id="tbPause" class="btn ebtn" title="Pausa"><i class="fa-solid fa-pause"></i></button>
  <button id="tbStop"  class="btn ebtn" title="Stop"><i class="fa-solid fa-stop"></i></button>
  <label class="visually-hidden" for="voiceSel">Voce</label>
  <select id="voiceSel" class="btn" style="min-width:12ch" title="Voce sintetica"></select>
  <label class="visually-hidden" for="rate">Velocità</label>
  <input type="range" id="rate" min="0.7" max="1.4" step="0.05" value="1" title="Velocità" style="accent-color:var(--accent)">
  <span class="sep"></span>
  <!-- Docente on demand + stampa -->
  <button id="tbDoc" class="btn tbtn" aria-pressed="false" title="Mostra/Nascondi sezione per il docente"><i class="fa-solid fa-chalkboard-user"></i> Docente</button>
  <button id="tbPrint" class="btn ebtn" title="Stampa/PDF"><i class="fa-solid fa-print"></i></button>
  <span class="sep"></span>
  <span class="state-pill" id="pillStateTop">Pronto</span>
  <span class="sep"></span>
  <!-- Indicatore Passo X/Y -->
  <div class="stepper" aria-live="polite">
    <div class="dot" id="dot1"></div><div class="dot" id="dot2"></div><div class="dot" id="dot3"></div><div class="dot" id="dot4"></div><div class="dot" id="dot5"></div><div class="dot" id="dot6"></div><div class="dot" id="dot7"></div><div class="dot" id="dot8"></div>
    <span class="label" id="stepLabel">Passo 1/8</span>
  </div>
</div>

<div class="app" id="appRoot">
  <!-- MAIN -->
  <main class="main" id="main">
    <article id="content" class="content" aria-live="polite">
      <!-- ORIENTAMENTO -->
      <header id="orientamento" class="card">
        <h1><i class="fa-solid fa-book"></i> [TITOLO_ARGOMENTO: sintetico, concreto, livello scolastico tra parentesi se utile. Evita giochi di parole.]</h1>
        <p class="notice"><strong>Che cosa imparerai.</strong> [SCOP0_IN_2_RIGHE: linguaggio semplice (CEFR B1), 1 frase per riga, 1–3 abilità misurabili.]</p>
        <p class="notice"><strong>A che ti servirà.</strong> [UTILITÀ_IN_2_RIGHE: contesto autentico in cui applicare il concetto.]</p>
        <div class="prestart">
          <p class="prestart-title"><strong>Prima di iniziare devi sapere che…</strong></p>
          <div class="prestart-body">[PRIMA_DI_INIZIARE: breve recap narrativo con informazioni di base utili agli studenti.]</div>
        </div>
      </header>

      <!-- IMMAGINE DI CONTESTO -->
      <section id="immagine" class="card">
        <h2><i class="fa-solid fa-image"></i> Immagine di contesto</h2>
        <figure>
          <img src="https://picsum.photos/seed/argomento/1200/600" alt="[ALT_IMMAGINE: descrizione funzionale, 10–15 parole che connettono l’immagine al concetto]">
          <div data-role="inline-svg" hidden aria-hidden="true"></div>
          <figcaption>
            <span data-role="caption-text">[DIDASCALIA_IMMAGINE: 1 riga che collega l’immagine al nucleo della lezione].</span>
            <span data-role="credit-wrapper">Fonte: <a data-role="credit-link" href="https://picsum.photos/" target="_blank" rel="noopener">https://picsum.photos/</a></span>
          </figcaption>
        </figure>
      </section>

      <!-- PERCORSO MODULARE -->
      <section id="percorso" class="card">
        <h2><i class="fa-solid fa-layer-group"></i> Percorso modulare</h2>

        <!-- Modulo 1 -->
        <div class="concept">
          <div class="concept-icon" aria-hidden="true"><i class="fa-solid fa-1"></i></div>
          <div class="concept-text">
            <p class="estesa"><i class="fa-solid fa-book-open"></i> <strong>[MODULO_1_TITOLO]</strong>: [MODULO_1_DEFINIZIONE].</p>
            <p class="estesa"><i class="fa-solid fa-image"></i> Esempio: [MODULO_1_ESEMPIO].</p>
            <p class="estesa"><i class="fa-solid fa-ban"></i> Controesempio: [MODULO_1_CONTROESEMPIO].</p>
            <p class="semplificata"><strong>[MODULO_1_TITOLO_SEMPLIFICATO]</strong>: [MODULO_1_RISCRITTURA_SEMPLICE].</p>
            <details class="details-lite"><summary>Approfondisci <span class="tag">+</span></summary><p>[MODULO_1_APPROFONDIMENTO].</p></details>
          </div>
        </div>

        <!-- Modulo 2 -->
        <div class="concept">
          <div class="concept-icon" aria-hidden="true"><i class="fa-solid fa-2"></i></div>
          <div class="concept-text">
            <p class="estesa"><i class="fa-solid fa-book-open"></i> <strong>[MODULO_2_TITOLO]</strong>: [MODULO_2_DEFINIZIONE].</p>
            <p class="estesa"><i class="fa-solid fa-image"></i> Esempio: [MODULO_2_ESEMPIO].</p>
            <p class="estesa"><i class="fa-solid fa-ban"></i> Controesempio: [MODULO_2_CONTROESEMPIO].</p>
            <p class="semplificata"><strong>[MODULO_2_TITOLO_SEMPLIFICATO]</strong>: [MODULO_2_RISCRITTURA_SEMPLICE].</p>
            <details class="details-lite"><summary>Approfondisci <span class="tag">+</span></summary><p>[MODULO_2_APPROFONDIMENTO].</p></details>
          </div>
        </div>

        <!-- Modulo 3 -->
        <div class="concept">
          <div class="concept-icon" aria-hidden="true"><i class="fa-solid fa-3"></i></div>
          <div class="concept-text">
            <p class="estesa"><i class="fa-solid fa-book-open"></i> <strong>[MODULO_3_TITOLO]</strong>: [MODULO_3_DEFINIZIONE].</p>
            <p class="estesa"><i class="fa-solid fa-image"></i> Esempio: [MODULO_3_ESEMPIO].</p>
            <p class="estesa"><i class="fa-solid fa-ban"></i> Controesempio: [MODULO_3_CONTROESEMPIO].</p>
            <p class="semplificata"><strong>[MODULO_3_TITOLO_SEMPLIFICATO]</strong>: [MODULO_3_RISCRITTURA_SEMPLICE].</p>
            <details class="details-lite"><summary>Approfondisci <span class="tag">+</span></summary><p>[MODULO_3_APPROFONDIMENTO].</p></details>
          </div>
        </div>
      </section>

      <!-- MICRO-ATTIVAZIONE -->
      <section id="attivazione" class="card">
        <h2><i class="fa-solid fa-bolt"></i> Micro-attivazione</h2>
        <p>[ISTRUZIONI_BREVI: 1 riga per spiegare che seguono 2 stimoli a basso sforzo.]</p>
        <div class="microqa">
          <div class="item" data-correct="A">
            <p>[DOMANDA_RIATTIVAZIONE_1: chiusa a 2 opzioni, 1 riga.]</p>
            <div class="choices">
              <button data-choice="A">[OPZIONE_A: corretta]</button>
              <button data-choice="B">[OPZIONE_B: distrattore tipico]</button>
            </div>
            <div class="feedback"></div>
          </div>
          <div class="item" data-correct="Vero">
            <p>[DOMANDA_RIATTIVAZIONE_2: vero/falso, sul nucleo.]</p>
            <div class="choices">
              <button data-choice="Vero">Vero</button>
              <button data-choice="Falso">Falso</button>
            </div>
            <div class="feedback"></div>
          </div>
        </div>
        <aside class="card sticky-note" aria-label="Falsi amici">
          <h3><i class="fa-solid fa-triangle-exclamation"></i> Falsi amici</h3>
          <ul>
            <li>[FALSO_AMICO_1: formula comune ma errata + correzione breve.]</li>
            <li>[FALSO_AMICO_2: misunderstanding atteso + chiarimento operativo.]</li>
          </ul>
        </aside>
      </section>

      <!-- PRIMER -->
      <section id="primer" class="card">
        <h2><i class="fa-solid fa-rocket"></i> Primer rapido</h2>
        <p><i class="fa-solid fa-book-open"></i> <strong>Idea chiave.</strong> [DEFINIZIONE_OPERATIVA].</p>
        <p><i class="fa-solid fa-image"></i> <strong>Esempio concreto.</strong> [ESEMPIO_PULITO].</p>
      </section>

      <!-- MAPPA (MERMAID) -->
      <section id="schema" class="card">
        <h2><i class="fa-solid fa-sitemap"></i> Mappa dell’argomento (Mermaid)</h2>
        <div class="mermaid-wrap">
<div class="mermaid" id="mermaidMap">
flowchart TD
  A("NODO_1 — concetto iniziale")
  B("NODO_2 — passo successivo")
  C("NODO_3 — esito o principio chiave")
  D("NODO_4 — alternativa/ramo")
  A -->|etichetta 1: causa/condizione/segue| B
  B -->|etichetta 2| C
  A -->|etichetta 3| D
</div>
        </div>
      </section>

      <!-- ATTIVITÀ GUIDATA -->
      <section id="attivita" class="card">
        <h2><i class="fa-solid fa-person-chalkboard"></i> Attività guidata (compito breve)</h2>
        <p class="notice">[ISTRUZIONI_COMPITO: 1–2 frasi. Genera un errore frequente e correggilo con aiuti progressivi.]</p>
        <div id="taskOrder" style="display:flex;gap:.6rem;flex-wrap:wrap;margin:.6rem 0" aria-label="Ordina i passaggi">
          <button data-step="[STEP_A]">[STEP_A: primo passo]</button>
          <button data-step="[STEP_B]">[STEP_B: secondo passo]</button>
          <button data-step="[STEP_C]">[STEP_C: terzo passo]</button>
        </div>
        <div id="taskOut" class="state-pill">Scelte: —</div>
        <div id="taskHelp" class="feedback learn" style="display:none"></div>
        <div style="display:flex;gap:.6rem;margin-top:.6rem">
          <button id="btnHelp1"><i class="fa-solid fa-lightbulb"></i> [AIUTO_1]</button>
          <button id="btnHelp2"><i class="fa-solid fa-circle-question"></i> [AIUTO_2]</button>
          <button id="btnHelp3"><i class="fa-solid fa-eye"></i> [SOLUZIONE_COMMENTATA]</button>
          <button id="btnResetOrder"><i class="fa-solid fa-rotate-left"></i> Reset</button>
        </div>
      </section>

      <!-- VERIFICA FORMATIVA -->
      <section id="quiz" class="card">
        <h2><i class="fa-solid fa-clipboard-list"></i> Verifica formativa</h2>
        <p id="quizIntro" class="notice">
          [ISTRUZIONI_QUIZ: 1 riga. Clicca una risposta, ricevi feedback; puoi chiedere un aiuto o la soluzione commentata.]
        </p>

        <div id="quizControls" style="display:flex;gap:.6rem;flex-wrap:wrap;margin:.6rem 0">
          <button id="btnReadQ"><i class="fa-solid fa-volume-high"></i> Leggi domanda</button>
          <button id="btnHint" style="display:none"><i class="fa-solid fa-lightbulb"></i> Suggerimento</button>
          <button id="btnShowSolution" style="display:none"><i class="fa-solid fa-eye"></i> Mostra soluzione</button>
          <button id="btnNext" disabled><i class="fa-solid fa-arrow-right"></i> Avanti</button>
          <span class="state-pill" id="quizState">Domanda 1</span>
        </div>

        <div id="quizList"></div>

        <div id="quizHint" class="feedback learn" style="display:none"></div>
        <div id="quizExplain" class="feedback" style="display:none"></div>
      </section>

      <!-- PER IL DOCENTE (nascosto di default, richiamabile da toolbar) -->
      <section id="docente" class="card" hidden>
        <h2><i class="fa-solid fa-chalkboard-user"></i> Per il docente</h2>
        <details class="details-lite" open>
          <summary>Criteri rapidi di osservazione <span class="tag">DOC</span></summary>
          <ul>
            <li>[CRITERIO_1]</li>
            <li>[CRITERIO_2]</li>
            <li>[CRITERIO_3]</li>
          </ul>
        </details>
        <details class="details-lite">
          <summary>Varianti per livelli diversi <span class="tag">DOC</span></summary>
          <ul>
            <li>[VARIANTE_BASE]</li>
            <li>[VARIANTE_INTERMEDIA]</li>
            <li>[VARIANTE_AVANZATA]</li>
          </ul>
        </details>
      </section>

      <!-- PAROLE CHIAVE + GLOSSARIO -->
      <section id="glossario" class="card">
        <h2><i class="fa-solid fa-key"></i> Parole chiave e glossario</h2>
        <div id="kwList" class="kw-list"></div>
        <dl>
          <dt><strong>[TERMINE_1]</strong></dt><dd>[DEFINIZIONE_1].</dd>
          <dt><strong>[TERMINE_2]</strong></dt><dd>[DEFINIZIONE_2].</dd>
          <dt><strong>[TERMINE_3]</strong></dt><dd>[DEFINIZIONE_3].</dd>
        </dl>
      </section>
    </article>
  </main>

  <!-- INDICE LATERALE (sticky) -->
  <aside class="toc" aria-label="Indice">
    <h2><i class="fa-solid fa-list-ol"></i> Indice</h2>
    <ol id="toc">
      <li><a href="#orientamento">Orientamento</a></li>
      <li><a href="#immagine">Immagine di contesto</a></li>
      <li><a href="#percorso">Percorso modulare</a></li>
      <li><a href="#attivazione">Micro-attivazione</a></li>
      <li><a href="#primer">Primer</a></li>
      <li><a href="#schema">Mappa (Mermaid)</a></li>
      <li><a href="#attivita">Attività guidata</a></li>
      <li><a href="#quiz">Verifica formativa</a></li>
      <li><a href="#docente">Per il docente</a></li>
      <li><a href="#glossario">Glossario</a></li>
    </ol>
  </aside>
</div>

<dialog id="importDialog" aria-labelledby="importDialogTitle" aria-describedby="importDialogDesc importError" aria-modal="true" hidden>
  <form id="importForm" method="dialog">
    <h2 id="importDialogTitle">Incolla JSON</h2>
    <p id="importDialogDesc">Incolla qui il JSON esportato dalla pagina e premi “Importa” per caricarlo.</p>
    <label class="visually-hidden" for="importTextarea">Contenuto JSON</label>
    <textarea id="importTextarea" name="importTextarea" rows="10" spellcheck="false" aria-describedby="importDialogDesc importError"></textarea>
    <p id="importError" class="error" role="alert" aria-live="assertive" hidden></p>
    <div class="actions">
      <button type="button" id="importCancel">Annulla</button>
      <button type="submit" id="importConfirm" class="primary">Importa</button>
    </div>
  </form>
</dialog>

<script>
/* =========================================================
   MERMAID
   ========================================================= */
document.addEventListener('DOMContentLoaded', () => {
  if (window.mermaid) {
    mermaid.initialize({
      startOnLoad:false,
      securityLevel:"loose",
      flowchart:{ htmlLabels:false, wrap:true }
    });
    mermaid.run({querySelector:'.mermaid'});
  }
});

/* =========================================================
   UTILITÀ + STATO
   ========================================================= */
const $=s=>document.querySelector(s);
const $$=s=>Array.from(document.querySelectorAll(s));
const content=$('#content');
const app=$('#appRoot');
const PREF='layoutInclusivo:template:senzaSidebar:v3';
const state=Object.assign({
  font:18,line:1.7,width:72,contrast:false,caps:false,
  simplified:false,bgIndex:0,fontIndex:0,
  rate:1.0,voiceURI:'',karaoke:false,ruler:false,showDoc:false,
  savedStepId:'orientamento'
}, JSON.parse(localStorage.getItem(PREF)||'{}'));
const save=()=>localStorage.setItem(PREF,JSON.stringify(state));

/* Temi sfondo (no nero) + font */
const BG=[
  {name:'Standard',bg:'#ffffff',fg:'#1f2328',card:'#f6f8fa',surface:'#fff',weak:'#f9fafb',border:'#d0d7de',muted:'#5a5f69'},
  {name:'Paglierino',bg:'#fff8dc',fg:'#1d1d1d',card:'#fffbe7',surface:'#fffdf2',weak:'#fff8e4',border:'#e6deb0',muted:'#6a644d'},
  {name:'Seppia',bg:'#f5efe6',fg:'#1e1a14',card:'#f2e9df',surface:'#f9f4ec',weak:'#f4ede3',border:'#d8cab8',muted:'#6b5e4e'},
  {name:'Grigio caldo',bg:'#f7f7f7',fg:'#1f2328',card:'#ffffff',surface:'#ffffff',weak:'#f4f4f4',border:'#d9d9d9',muted:'#666'}
];
const FONTS=[
  {name:'Sistema', stack:'system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif'},
  {name:'Atkinson Hyperlegible', stack:'"Atkinson Hyperlegible",system-ui,-apple-system,Segoe UI,Arial,sans-serif'},
  {name:'Lexend', stack:'"Lexend",system-ui,-apple-system,Segoe UI,Arial,sans-serif'},
  {name:'Readex Pro', stack:'"Readex Pro",system-ui,-apple-system,Segoe UI,Arial,sans-serif'}
];
function applyPrefs(){
  document.documentElement.style.setProperty('--font-size',state.font+'px');
  document.documentElement.style.setProperty('--line',state.line);
  document.documentElement.style.setProperty('--content',state.width+'ch');
  document.body.classList.toggle('contrast-high',!!state.contrast);
  document.body.classList.toggle('caps-on',!!state.caps);
  document.body.classList.toggle('mode-simplified',!!state.simplified);
  $('#docente')?.toggleAttribute('hidden', !state.showDoc);

  const t=BG[state.bgIndex%BG.length];
  const r=document.documentElement.style;
  r.setProperty('--bg',t.bg); r.setProperty('--fg',t.fg); r.setProperty('--card',t.card);
  r.setProperty('--surface',t.surface); r.setProperty('--surface-weak',t.weak);
  r.setProperty('--border',t.border); r.setProperty('--muted',t.muted);

  const f=FONTS[state.fontIndex%FONTS.length]; r.setProperty('--ff',f.stack);
  const label=(state.simplified?'Semplificata':'Completa')+(state.contrast?' · Contrasto':'')+(state.caps?' · MAIUSC':'')+(state.karaoke?' · Karaoke':'')+(state.ruler?' · Righello':'')+` · Sfondo: ${t.name} · Font: ${f.name}`;
  $('#pillStateTop').textContent=label;

  // Aggiorna stato visivo dei toggle persistenti
  $('#tbContrast').setAttribute('aria-pressed', String(!!state.contrast));
  $('#tbCaps').setAttribute('aria-pressed', String(!!state.caps));
  $('#tbRuler').setAttribute('aria-pressed', String(!!state.ruler));
  $('#tbSimplify').setAttribute('aria-pressed', String(!!state.simplified));
  $('#tbKaraoke').setAttribute('aria-pressed', String(!!state.karaoke));
  $('#tbDoc').setAttribute('aria-pressed', String(!!state.showDoc));

  save();
}
function clamp(n,min,max){return Math.max(min,Math.min(max,n));}

/* Barra progresso lettura */
const progressBar=document.querySelector('.read-progress>div');
function onScroll(){ const d=document.documentElement; const total=d.scrollHeight-d.clientHeight; const s=total>0?(d.scrollTop/total):0; progressBar.style.width=(s*100).toFixed(1)+'%'; }
document.addEventListener('scroll',onScroll,{passive:true}); onScroll();

/* Righello */
const ruler=$('#readingRuler');
document.addEventListener('mousemove',e=>{
  if(!state.ruler) return;
  const rect=content.getBoundingClientRect();
  if(e.clientY>=rect.top && e.clientY<=rect.bottom) ruler.style.transform=`translateY(${e.clientY - ruler.offsetHeight/2}px)`; else ruler.style.transform='translateY(-9999px)';
});

/* =========================================================
   KARAOKE / SINTESI VOCALE (Leggi ≠ Karaoke)
   ========================================================= */
const EXCLUDE_WRAP='script,style,code,pre,.mermaid,.kw-pop,button,.btn,[role="button"],input,select,textarea,.choice-list,.concept-icon';
const PLACEHOLDER_REGEX=/\[[\p{L}0-9_]+(?::[^\]]*)?\]/u;
const PLACEHOLDER_OPEN_REGEX=/\[[\p{L}0-9_]+(?::[^\]]*)?$/u;
function instrumentWords(root){
  const walker=document.createTreeWalker(root,NodeFilter.SHOW_TEXT,null);
  const toWrap=[]; let node;
  while(node=walker.nextNode()){
    const t=node.nodeValue; if(!t || !t.trim()) continue;
    if(node.parentElement.closest(EXCLUDE_WRAP)) continue;
    if(PLACEHOLDER_REGEX.test(t) || PLACEHOLDER_OPEN_REGEX.test(t)) continue;
    toWrap.push(node);
  }
  toWrap.forEach(n=>{
    const parts=n.nodeValue.split(/(\s+)/); const frag=document.createDocumentFragment();
    for(const part of parts){
      if(part==='') continue;
      if(/\s+/.test(part)) frag.appendChild(document.createTextNode(part));
      else{ const w=document.createElement('span'); w.className='word'; w.textContent=part; frag.appendChild(w); }
    }
    n.parentNode.replaceChild(frag,n);
  });
}
function instrumentSubtree(el){ instrumentWords(el); annotateKeywordWords(el); }

const synth=window.speechSynthesis; let voices=[]; let utter=null; let paused=false;
const LETTER_RE=/[A-Za-zÀ-ÖØ-öø-ÿ]/;
const SPEECH_RULES=[
  (text, index)=>{
    const slice=text.slice(index);
    const match=slice.match(/^a\.\s*c\./i);
    if(!match) return null;
    const prev=text[index-1]||'';
    const next=text[index+match[0].length]||'';
    if(LETTER_RE.test(prev) || LETTER_RE.test(next)) return null;
    return {length:match[0].length,replacement:'Avanti Cristo'};
  },
  (text, index)=>{
    if(text.length-index<9) return null;
    const candidate=text.slice(index,index+9);
    if(candidate.toLowerCase()!=='optimates') return null;
    const prev=text[index-1]||'';
    const next=text[index+9]||'';
    if(LETTER_RE.test(prev) || LETTER_RE.test(next)) return null;
    let replacement;
    if(candidate===candidate.toUpperCase()) replacement='OPTIMÀTES';
    else if(candidate[0]===candidate[0].toUpperCase()) replacement='Optimàtes';
    else replacement='optimàtes';
    return {length:9,replacement};
  }
];
function prepareSpeechText(text){
  if(!text) return {speechText:'', mapSpeechToOriginal:[], mapOriginalToSpeech:[]};
  let speechText='';
  const mapSpeechToOriginal=[];
  const mapOriginalToSpeech=new Array(text.length+1).fill(null);
  let i=0;
  while(i<text.length){
    if(mapOriginalToSpeech[i]===null) mapOriginalToSpeech[i]=speechText.length;
    let matched=false;
    for(const rule of SPEECH_RULES){
      const res=rule(text,i);
      if(res){
        const {length,replacement}=res;
        const span=length||1;
        for(let k=0;k<replacement.length;k++){
          const progress=span?Math.min(span, Math.round(((k+1)*span)/replacement.length)):0;
          mapSpeechToOriginal.push(i+progress);
        }
        speechText+=replacement;
        i+=length;
        if(mapOriginalToSpeech[i]===null) mapOriginalToSpeech[i]=speechText.length;
        matched=true;
        break;
      }
    }
    if(matched) continue;
    const ch=text[i];
    speechText+=ch;
    mapSpeechToOriginal.push(i);
    i++;
  }
  if(mapOriginalToSpeech[i]===null) mapOriginalToSpeech[i]=speechText.length;
  return {speechText,mapSpeechToOriginal,mapOriginalToSpeech};
}

/* Precarica voci, predefinita: Diego se disponibile (in italiano) */
function waitForVoices(ms=2500){return new Promise(res=>{let t=0;const s=100;const id=setInterval(()=>{if(synth.getVoices().length||t>=ms){clearInterval(id);res(synth.getVoices());}t+=s;},s);});}
async function setupVoices(){
  voices=synth.getVoices(); if(!voices.length) voices=await waitForVoices();
  const sel=$('#voiceSel'); sel.innerHTML='';
  const itVoices=voices.filter(v=>/it-|ital/i.test(v.lang));
  const list=itVoices.length?itVoices:voices;
  // Preferisci Diego, poi it-IT qualsiasi
  let preferred=list.find(v=>/diego/i.test(v.name)) || itVoices[0] || list[0];
  list.forEach(v=>{const o=document.createElement('option');o.value=v.voiceURI;o.textContent=`${v.name} – ${v.lang}`;sel.appendChild(o);});
  const keep = voices.find(v=>v.voiceURI===state.voiceURI);
  sel.value = (keep?.voiceURI) || (preferred?.voiceURI) || sel.value;
  if(!state.voiceURI){ state.voiceURI=sel.value; save(); }
}
if('speechSynthesis' in window){ setupVoices(); speechSynthesis.onvoiceschanged=setupVoices; }
const getSelVoice=()=>voices.find(v=>v.voiceURI===$('#voiceSel').value)||null;

let karaokeBundle=null, afterSpeak=null;
function buildTextAndRanges(root){
  let text=''; const ranges=[]; let idx=0;
  const visible=node=>{
    if(!(node instanceof Element)) return true;
    const cs=getComputedStyle(node);
    if(cs.display==='none' || cs.visibility==='hidden' || cs.opacity==='0') return false;
    if(node.closest('.semplificata') && !document.body.classList.contains('mode-simplified')) return false;
    if(node.closest('.estesa') &&  document.body.classList.contains('mode-simplified')) return false;
    return true;
  };
  const walk=(node)=>{
    if(node.nodeType===Node.TEXT_NODE){ const val=node.nodeValue||''; text+=val; idx+=val.length; return; }
    if(node.nodeType===Node.ELEMENT_NODE){
      if(!visible(node)) return;
      if(node.classList.contains('word')){ const v=node.textContent||''; ranges.push({start:idx,end:idx+v.length,el:node}); text+=v; idx+=v.length; return; }
      if(node.matches(EXCLUDE_WRAP)) return;
      node.childNodes.forEach(walk);
      if(/^(p|li|h\d|figcaption|summary|div)$/i.test(node.tagName)) { text+=' '; idx+=1; }
    }
  };
  walk(root); return {text,ranges};
}

/* Karaoke ON/OFF (toggle persistente con evidenziazione) */
function speakBundle(){
  if(!karaokeBundle || !karaokeBundle.text.trim()) return;
  stopTTS(true);
  const speechPrep=prepareSpeechText(karaokeBundle.text);
  karaokeBundle.mapSpeechToOriginal=speechPrep.mapSpeechToOriginal;
  utter=new SpeechSynthesisUtterance(speechPrep.speechText);
  utter.rate=state.rate||1.0;
  const v=getSelVoice(); if(v) utter.voice=v; utter.lang=v?.lang||'it-IT';

  let ptr=-1;
  const act=(ci)=>{
    if(!state.karaoke || !karaokeBundle.ranges.length) return;
    const map=karaokeBundle.mapSpeechToOriginal;
    const idx=map?.length ? map[Math.min(Math.max(ci,0), map.length-1)] ?? ci : ci;
    while(ptr+1<karaokeBundle.ranges.length && idx>=karaokeBundle.ranges[ptr+1].start) ptr++;
    const target=karaokeBundle.ranges[Math.max(0,ptr)];
    if(!target) return;
    const prev=$('#content .word.active'); if(prev) prev.classList.remove('active');
    target.el.classList.add('active');
    const r=target.el.getBoundingClientRect(); if(r.top<0 || r.bottom>window.innerHeight){ target.el.scrollIntoView({behavior:'smooth',block:'center'}); }
  };
  utter.onboundary=(e)=>{ if(e.name==='word' || typeof e.charIndex==='number') act(e.charIndex||0); };
  utter.onstart=()=>{ $('#pillStateTop').textContent='In lettura…'; content.classList.add('karaoke'); };
  const clearUI=msg=>{ const prev=$('#content .word.active'); if(prev) prev.classList.remove('active'); content.classList.remove('karaoke'); $('#pillStateTop').textContent=msg; };
  utter.onend=()=>{ state.karaoke=false; applyPrefs(); clearUI('Completato'); const cb=afterSpeak; afterSpeak=null; if(typeof cb==='function') cb(); };
  utter.onerror=()=>{ state.karaoke=false; applyPrefs(); clearUI('Errore lettura'); afterSpeak=null; };
  try{ synth.speak(utter); }catch(_){}
}
function stopTTS(quiet=false){
  if(synth.speaking||synth.pending) synth.cancel();
  const prev=$('#content .word.active'); if(prev) prev.classList.remove('active');
  content.classList.remove('karaoke');
  if(!quiet){ $('#pillStateTop').textContent='Pronto'; }
}

/* Leggi (NO karaoke): legge selezione o l’intero articolo */
function getSelectedOrAll(){
  const sel=window.getSelection();
  if(sel && String(sel).trim()){
    const div=document.createElement('div'); div.textContent=String(sel).trim(); return div;
  }
  return $('#content');
}
function speakPlain(el){
  stopTTS(true);
  const bundle=buildTextAndRanges(el); // riuso estrazione testo ma senza boundary/hl
  const speechPrep=prepareSpeechText(bundle.text);
  utter=new SpeechSynthesisUtterance(speechPrep.speechText);
  utter.rate=state.rate||1.0;
  const v=getSelVoice(); if(v) utter.voice=v; utter.lang=v?.lang||'it-IT';
  utter.onstart=()=>{ $('#pillStateTop').textContent='In lettura…'; };
  utter.onend=()=>{ $('#pillStateTop').textContent='Completato'; };
  utter.onerror=()=>{ $('#pillStateTop').textContent='Errore lettura'; };
  try{ synth.speak(utter); }catch(_){}
}

/* =========================================================
   RICERCA PAROLE CHIAVE (POPOVER ANCHE NEL TESTO)
   ========================================================= */
const KW={map:new Map(), norm:new Map()};
const norm=s=>(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
function buildGlossary(){
  KW.map.clear(); KW.norm.clear();
  $$('#glossario dt').forEach(dt=>{
    const term=(dt.textContent||'').trim(); const dd=dt.nextElementSibling?.textContent?.trim()||'';
    if(term){ KW.map.set(term.toLowerCase(), dd); KW.norm.set(norm(term), dd); }
  });
  const list=$('#kwList'); list.innerHTML='';
  for(const term of KW.map.keys()){
    const b=document.createElement('button'); b.className='kw-pill'; b.type='button'; b.textContent=term;
    b.addEventListener('click',()=>showKwPopover(term,b));
    list.appendChild(b);
  }
}
function annotateKeywordWords(root=document){ $$('#content .word').forEach(w=>{ const t=norm(w.textContent||''); if(KW.norm.has(t)){ w.classList.add('kw-word'); w.tabIndex=0; w.dataset.term=(w.textContent||'').trim().toLowerCase(); }}); }

let kwPop=null, kwAnchor=null, kwLastFocus=null;
function showKwPopover(term, anchor){
  const def=KW.map.get((term||'').toLowerCase()) || KW.norm.get(norm(term)) || 'Definizione non ancora fornita.';
  hideKwPopover();
  kwAnchor=anchor; kwLastFocus=document.activeElement;
  kwPop=document.createElement('div'); kwPop.className='kw-pop';
  kwPop.innerHTML=`<button class="x" aria-label="Chiudi">✕</button><div class="t">${escapeHTML(term)}</div><p>${escapeHTML(def)}</p>`;
  document.body.appendChild(kwPop);
  positionKwPopover(anchor, kwPop);
  kwPop.querySelector('.x').addEventListener('click', hideKwPopover);
  setTimeout(()=>kwPop.focus?.(),0);
  document.addEventListener('keydown', kwEsc, true);
  document.addEventListener('click', kwAutoClose, true);
  window.addEventListener('resize', kwReposition, {passive:true});
  window.addEventListener('scroll', kwReposition, {passive:true});
}
function hideKwPopover(){
  if(!kwPop) return;
  document.removeEventListener('keydown', kwEsc, true);
  document.removeEventListener('click', kwAutoClose, true);
  window.removeEventListener('resize', kwReposition);
  window.removeEventListener('scroll', kwReposition);
  kwPop.remove(); kwPop=null;
  const f=kwLastFocus||kwAnchor; if(f && f.focus) f.focus();
  kwLastFocus=null; kwAnchor=null;
}
function kwEsc(e){ if(e.key==='Escape') hideKwPopover(); }
function kwAutoClose(e){ if(!kwPop) return; const inPop=e.target.closest?.('.kw-pop'); const inAnchor=kwAnchor && (e.target===kwAnchor||kwAnchor.contains?.(e.target)); if(!inPop && !inAnchor) hideKwPopover(); }
function kwReposition(){ if(kwPop && kwAnchor) positionKwPopover(kwAnchor, kwPop); }
function positionKwPopover(anchor, pop){
  const a=anchor.getBoundingClientRect(); const vw=innerWidth, vh=innerHeight; const m=10;
  const pw=Math.min(440, vw*.92); pop.style.maxWidth=pw+'px';
  let left=a.left + a.width/2 - pw/2; let top=a.bottom + m;
  left=Math.max(m, Math.min(vw-m-pw, left));
  if(top+pop.offsetHeight>vh-m){ top=Math.max(m, a.top - pop.offsetHeight - m); }
  pop.style.left=Math.round(left)+'px'; pop.style.top=Math.round(top)+'px';
}
function escapeHTML(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}

/* Click nel testo su parole chiave annotate */
document.addEventListener('click', (e)=>{
  const w=e.target.closest?.('.kw-word'); if(!w) return;
  const term=(w.dataset.term||w.textContent||'').trim();
  showKwPopover(term, w);
});

/* =========================================================
   MICRO-ATTIVAZIONE
   ========================================================= */
$('.microqa')?.addEventListener('click',e=>{
  const b=e.target.closest('button[data-choice]'); if(!b) return;
  const item=b.closest('.item'); const fb=item.querySelector('.feedback');
  const correct=item.dataset.correct;
  if(b.dataset.choice===correct){
    fb.textContent='Corretto. Hai attivato l’idea giusta.';
  }else{
    fb.textContent='Quasi. Rileggi la domanda: punta all’aspetto centrale, non al contesto.';
  }
});

/* =========================================================
   ATTIVITÀ GUIDATA
   ========================================================= */
let lastIngestedData=null;
let orderGoal=[];
let selectedOrder=[];
const guidedTaskTexts={success:'',retry:'',help1:'',help2:'',help3:''};
function updateOrderOut(){ $('#taskOut').textContent = 'Scelte: ' + (selectedOrder.join(' → ') || '—'); }
function readButtonLabel(el){
  if(!el) return '';
  return (el.textContent||'').trim();
}
function getPlaceholderValue(key, fallback=''){
  const raw=lastIngestedData?.placeholders?.[key];
  if(typeof raw==='string' && raw.trim()) return raw.trim();
  return fallback;
}
function initGuidedTask(){
  const btns=Array.from(document.querySelectorAll('#taskOrder button[data-step]'));
  orderGoal=btns.map(btn=>{
    const val=(btn.dataset.step??btn.textContent??'').trim();
    return val;
  }).filter(Boolean);
  selectedOrder=[];
  updateOrderOut();
  const helpEl=$('#taskHelp');
  if(helpEl){
    helpEl.style.display='none';
    helpEl.textContent='';
  }
  guidedTaskTexts.success=getPlaceholderValue('SPIEGAZIONE_SUCCINTA','[SPIEGAZIONE_SUCCINTA]');
  guidedTaskTexts.retry=getPlaceholderValue('INDIZIO_DIAGNOSTICO','[INDIZIO_DIAGNOSTICO]');
  guidedTaskTexts.help1=getPlaceholderValue('AIUTO_1', readButtonLabel($('#btnHelp1')) || '[AIUTO_1]');
  guidedTaskTexts.help2=getPlaceholderValue('AIUTO_2', readButtonLabel($('#btnHelp2')) || '[AIUTO_2]');
  guidedTaskTexts.help3=getPlaceholderValue('SOLUZIONE_COMMENTATA', readButtonLabel($('#btnHelp3')) || '[SOLUZIONE_COMMENTATA]');
}
$('#taskOrder').addEventListener('click',e=>{
  const b=e.target.closest('button[data-step]'); if(!b) return;
  const val=(b.dataset.step||'').trim(); if(!val || selectedOrder.includes(val)) return;
  selectedOrder.push(val); updateOrderOut();
  if(selectedOrder.length===orderGoal.length){
    const ok=selectedOrder.every((v,i)=>v===orderGoal[i]);
    const help=$('#taskHelp'); help.style.display='block';
    const successText=guidedTaskTexts.success ? ` ${escapeHTML(guidedTaskTexts.success)}` : '';
    const retryText=guidedTaskTexts.retry ? `Rifletti: ${escapeHTML(guidedTaskTexts.retry)}` : 'Rifletti.';
    help.innerHTML = ok
      ? `<div class="good"><i class="fa-solid fa-check"></i> Ben fatto.</div>${successText}`
      : retryText;
  }
});
$('#btnResetOrder').addEventListener('click',()=>{ selectedOrder=[]; updateOrderOut(); const h=$('#taskHelp'); h.style.display='none'; h.textContent=''; });
$('#btnHelp1').addEventListener('click',()=>{ const h=$('#taskHelp'); h.style.display='block'; h.textContent=(guidedTaskTexts.help1||'[AIUTO_1]'); });
$('#btnHelp2').addEventListener('click',()=>{ const h=$('#taskHelp'); h.style.display='block'; h.textContent=(guidedTaskTexts.help2||'[AIUTO_2]'); });
$('#btnHelp3').addEventListener('click',()=>{ const h=$('#taskHelp'); h.style.display='block'; const txt=guidedTaskTexts.help3||'[SOLUZIONE_COMMENTATA]'; h.innerHTML=`<div class="good"><i class="fa-solid fa-bolt"></i> Soluzione.</div> ${escapeHTML(txt)}`; });

/* =========================================================
   QUIZ UNIFICATO
   ========================================================= */
const quizData=[
  // Mantieni sincronizzato con la logica in ingestData
  {q:"[Q1_TESTO: concetto chiave #1]", choices:["[Q1_OPZ_1]","[Q1_OPZ_2]","[Q1_OPZ_3]","[Q1_OPZ_4]"], correct:1, hint:"[Q1_HINT]", explain:"[Q1_SPEGAZIONE]."},
 {q:"[Q2_TESTO: concetto chiave #2]", choices:["[Q2_OPZ_1]","[Q2_OPZ_2]","[Q2_OPZ_3]","[Q2_OPZ_4]"], correct:0, hint:"[Q2_HINT]", explain:"[Q2_SPEGAZIONE]."},
 {q:"[Q3_TESTO: applicazione di base]", choices:["[Q3_OPZ_1]","[Q3_OPZ_2]","[Q3_OPZ_3]","[Q3_OPZ_4]"], correct:2, hint:"[Q3_HINT]", explain:"[Q3_SPEGAZIONE]."}
];
let qi=0, attempts=0, quizIntroSpoken=false;
const quizListEl=$('#quizList');
const quizHintEl=$('#quizHint');
const quizExplainEl=$('#quizExplain');
const btnReadQ=$('#btnReadQ');
const btnNext=$('#btnNext');
const btnHint=$('#btnHint');
const btnShowSolution=$('#btnShowSolution');
const quizState=$('#quizState');

function renderQuizList(){
  quizListEl.innerHTML='';
  quizData.forEach((q,idx)=>{
    const wrap=document.createElement('div'); wrap.className='quiz-item'; wrap.dataset.index=idx;
    const qEl=document.createElement('div'); qEl.className='qtext'; qEl.style.fontWeight='700'; qEl.style.marginBottom='.5rem';
    qEl.textContent=`Domanda ${idx+1}/${quizData.length}. ${q.q}`; wrap.appendChild(qEl);
    const ul=document.createElement('ul'); ul.className='choice-list'; ul.setAttribute('role','radiogroup');
    q.choices.forEach((txt,i)=>{
      const li=document.createElement('li'); li.className='choice'; li.setAttribute('role','radio'); li.setAttribute('aria-checked','false'); li.tabIndex=0;
      li.innerHTML=`<label style="display:block;cursor:pointer">${txt}</label>`;
      li.addEventListener('click',()=>grade(idx,i,li));
      li.addEventListener('keydown',(e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); grade(idx,i,li);} });
      ul.appendChild(li);
    });
    wrap.appendChild(ul);
    quizListEl.appendChild(wrap);
  });
}
function setActiveQuestion(idx, opts){
  let shouldScroll=true;
  if(typeof opts==='boolean'){ shouldScroll=opts; }
  else if(opts && typeof opts==='object' && 'scroll' in opts){ shouldScroll=opts.scroll; }
  qi=idx; attempts=0; resetQuizFeedback(); btnNext.disabled=true;
  $$('.quiz-item').forEach(el=>el.classList.toggle('active', Number(el.dataset.index)===qi));
  instrumentSubtree($('.quiz-item.active'));
  updateQuizState();
  if(shouldScroll!==false){ $('.quiz-item.active').scrollIntoView({behavior:'smooth',block:'center'}); }
}
function updateQuizState(){ quizState.textContent=`Domanda ${qi+1}/${quizData.length}`; }
function resetQuizFeedback(){
  quizHintEl.style.display='none'; quizExplainEl.style.display='none';
  quizHintEl.textContent=''; quizExplainEl.textContent='';
  btnHint.style.display='none'; btnShowSolution.style.display='none';
}
function lockActiveChoices(){ $$('.quiz-item.active .choice').forEach(c=>c.style.pointerEvents='none'); }
function grade(qIndex, choiceIndex, li){
  if(qIndex!==qi) setActiveQuestion(qIndex);
  const q=quizData[qi];
  $$('.quiz-item.active .choice').forEach(c=>{ c.classList.remove('selected'); c.setAttribute('aria-checked','false'); });
  li.classList.add('selected'); li.setAttribute('aria-checked','true');
  if(choiceIndex===q.correct){
    li.classList.add('correct'); lockActiveChoices();
    quizExplainEl.innerHTML = `<div class="good"><i class="fa-solid fa-check"></i> Ben fatto.</div> ${escapeHTML(q.explain)}`;
    quizExplainEl.style.display='block';
    btnNext.disabled=false; btnHint.style.display='none'; btnShowSolution.style.display='none';
    // Leggi feedback in voce "plain"
    const tmp=document.createElement('div'); tmp.textContent=quizExplainEl.textContent; speakPlain(tmp);
  }else{
    li.classList.add('wrong'); li.style.pointerEvents='none';
    attempts++;
    quizHintEl.textContent = q.hint || 'Riprova: individua il passaggio davvero importante nella domanda.';
    quizHintEl.style.display='block';
    btnHint.style.display='inline-block'; btnShowSolution.style.display='inline-block';
    const tmp=document.createElement('div'); tmp.textContent=quizHintEl.textContent; speakPlain(tmp);
  }
}
function showExtraHint(){
  const q=quizData[qi];
  const extra=`Rileggi con calma: ${q.q} Elimina i distrattori che non rispettano la definizione.`;
  quizHintEl.innerHTML = `${escapeHTML(quizHintEl.textContent)}<br>${escapeHTML(extra)}`;
  quizHintEl.style.display='block';
  const tmp=document.createElement('div'); tmp.textContent=quizHintEl.textContent; speakPlain(tmp);
}
function revealSolution(){
  const q=quizData[qi];
  $$('.quiz-item.active .choice').forEach((c,idx)=>{ if(idx===q.correct) c.classList.add('correct'); c.style.pointerEvents='none'; });
  quizExplainEl.innerHTML = `<div class="good"><i class="fa-solid fa-bolt"></i> Soluzione commentata.</div> ${escapeHTML(q.explain)}`;
  quizExplainEl.style.display='block';
  btnNext.disabled=false;
  const tmp=document.createElement('div'); tmp.textContent=quizExplainEl.textContent; speakPlain(tmp);
}
function nextQuestion(){
  if(qi<quizData.length-1){ setActiveQuestion(qi+1); }
  else{
    quizExplainEl.innerHTML = `<div class="good"><i class="fa-solid fa-flag-checkered"></i> Verifica completata.</div> [CONSIGLIO_STUDIO].`;
    quizExplainEl.style.display='block';
    btnNext.disabled=true; btnHint.style.display='none'; btnShowSolution.style.display='none';
    const tmp=document.createElement('div'); tmp.textContent=quizExplainEl.textContent; speakPlain(tmp);
  }
}
btnReadQ.addEventListener('click', ()=>{
  if(!quizIntroSpoken){
    quizIntroSpoken=true;
    speakPlain($('#quizIntro')); // plain
    setTimeout(readCurrentQuestionPack, 300);
  }else readCurrentQuestionPack();
});
function readCurrentQuestionPack(){
  const active=$('.quiz-item.active');
  const pack=document.createElement('div');
  pack.appendChild(active.querySelector('.qtext').cloneNode(true));
  const opts=document.createElement('ul'); opts.innerHTML = $$('.quiz-item.active .choice label').map(l=>`<li>${l.textContent}</li>`).join('');
  pack.appendChild(opts); speakPlain(pack);
}
btnNext.addEventListener('click', nextQuestion);
btnHint.addEventListener('click', showExtraHint);
btnShowSolution.addEventListener('click', revealSolution);

/* =========================================================
   INDICATORE DI PASSO
   ========================================================= */
const STEPS=['orientamento','immagine','percorso','attivazione','primer','schema','attivita','quiz'];
let currentStepIndex=0;
function setStepById(id){
  const i=STEPS.indexOf(id); if(i>=0){ currentStepIndex=i; updateStepperUI(); state.savedStepId=id; save(); }
}
function updateStepperUI(){
  $$('.stepper .dot').forEach((d,idx)=>d.classList.toggle('active', idx<=currentStepIndex));
  $('#stepLabel').textContent = `Passo ${currentStepIndex+1}/${STEPS.length}`;
}
const obs=new IntersectionObserver(entries=>{
  entries.forEach(en=>{
    if(en.isIntersecting){
      const id=en.target.id;
      if(STEPS.includes(id)){ setStepById(id); }
    }
  });
},{root:null,rootMargin:'-40% 0px -50% 0px',threshold:0.0});
STEPS.forEach(id=>{ const el=document.getElementById(id); if(el) obs.observe(el); });

/* =========================================================
   CONTROLLI UI (toolbar)
   ========================================================= */
const incFont=d=>{state.font=clamp(state.font+d,14,28);applyPrefs();};
function cycleWidth(){ const v=[60,72,84]; state.width=v[(v.indexOf(state.width)+1)%v.length]; applyPrefs(); }
function cycleSpacing(){ const v=[1.7,1.9,2.1]; state.line=v[(v.indexOf(state.line)+1)%v.length]; applyPrefs(); }

$('#tbFontMinus').addEventListener('click',()=>incFont(-2));
$('#tbFontPlus').addEventListener('click',()=>incFont(+2));
$('#tbSpacing').addEventListener('click',cycleSpacing);
$('#tbWidth').addEventListener('click',cycleWidth);
$('#tbBg').addEventListener('click',()=>{state.bgIndex=(state.bgIndex+1)%BG.length;applyPrefs();});
$('#tbFontCycle').addEventListener('click',()=>{state.fontIndex=(state.fontIndex+1)%FONTS.length;applyPrefs();});

$('#tbContrast').addEventListener('click',()=>{state.contrast=!state.contrast;applyPrefs();});
$('#tbCaps').addEventListener('click',()=>{state.caps=!state.caps;applyPrefs();});
$('#tbRuler').addEventListener('click',()=>{state.ruler=!state.ruler;applyPrefs();});
$('#tbSimplify').addEventListener('click',()=>{state.simplified=!state.simplified;applyPrefs();});
$('#tbDoc').addEventListener('click',()=>{state.showDoc=!state.showDoc;applyPrefs();});

// Karaoke toggle: se ON e non sta parlando, avvia; se OFF, ferma
$('#tbKaraoke').addEventListener('click',()=>{
  state.karaoke=!state.karaoke; applyPrefs();
  if(state.karaoke){
    instrumentSubtree(content);
    karaokeBundle=buildTextAndRanges(content);
    speakBundle();
  }else{
    stopTTS();
  }
});

// TTS plain
$('#voiceSel').addEventListener('change',e=>{state.voiceURI=e.target.value;save();});
$('#rate').addEventListener('input',e=>{state.rate=parseFloat(e.target.value);save();});
$('#tbSpeak').addEventListener('click',()=>{ const el=getSelectedOrAll(); speakPlain(el); });
$('#tbPause').addEventListener('click',()=>{
  if(!speechSynthesis.speaking) return;
  if(!paused){ speechSynthesis.pause(); paused=true; $('#pillStateTop').textContent='In pausa'; }
  else{ speechSynthesis.resume(); paused=false; $('#pillStateTop').textContent='In lettura…'; }
});
$('#tbStop').addEventListener('click',()=>{ paused=false; stopTTS(); });

$('#tbPrint').addEventListener('click',()=>window.print());

/* Shortcut tastiera essenziali */
document.addEventListener('keydown',e=>{
  if(/input|textarea|select/i.test(e.target.tagName)) return;
  if((e.key==='+'||e.key==='=')&&(e.ctrlKey||e.metaKey)){ e.preventDefault(); state.font=clamp(state.font+2,14,28); applyPrefs(); }
  if(e.key==='-'&&(e.ctrlKey||e.metaKey)){ e.preventDefault(); state.font=clamp(state.font-2,14,28); applyPrefs(); }
  const k=e.key.toLowerCase();
  if(k==='c'){ state.contrast=!state.contrast; applyPrefs(); }
  if(k==='r'){ state.ruler=!state.ruler; applyPrefs(); }
  if(k==='s'){ state.simplified=!state.simplified; applyPrefs(); }
  if(k==='k'){ state.karaoke=!state.karaoke; applyPrefs(); if(state.karaoke){ instrumentSubtree(content); karaokeBundle=buildTextAndRanges(content); speakBundle(); } else { stopTTS(); } }
  if(k==='u'){ state.caps=!state.caps; applyPrefs(); }
});

/* =========================================================
   AVVIO
   ========================================================= */
buildGlossary();
instrumentWords(content);
annotateKeywordWords();
renderQuizList();
setActiveQuestion(0,false);
applyPrefs();

/* TOC: aggiorna passo su click */
$('#toc')?.addEventListener('click',e=>{
  const a=e.target.closest('a[href^="#"]'); if(!a) return;
  const id=a.getAttribute('href').slice(1); setStepById(id);
});

/* ARIA live announcer */
const live=document.createElement('div'); live.setAttribute('aria-live','polite'); live.setAttribute('aria-atomic','true'); live.style.position='fixed'; live.style.left='-9999px'; live.style.top='-9999px'; document.body.appendChild(live);
function announce(msg){ live.textContent=msg; }
</script>

<!-- ==== UPGRADE PACK: Import/Export + Incolla JSON + Segnaposto Globali ==== -->
<script>
(function(){
  // Safe helpers (use existing functions if present, else no-op)
  const NOP = function(){};
  const has = (n)=> typeof window[n] === 'function';
  const call = (n, ...args)=> has(n) ? window[n](...args) : undefined;
  const ensure = (n, fn)=> { if(!has(n)) window[n]=fn; };

  const importDialog=document.getElementById('importDialog');
  const importForm=importDialog?.querySelector('#importForm');
  const importTextarea=importDialog?.querySelector('#importTextarea');
  const importError=importDialog?.querySelector('#importError');
  const importCancelBtn=importDialog?.querySelector('#importCancel');
  let importDialogLastFocus=null;

  function resetImportDialog(){
    if(importTextarea){ importTextarea.value=''; importTextarea.removeAttribute('aria-invalid'); }
    if(importError){ importError.textContent=''; importError.hidden=true; }
  }

  function showImportError(message){
    if(!importError) return;
    importError.textContent=message;
    importError.hidden=false;
    importTextarea?.setAttribute('aria-invalid','true');
  }

  function openImportDialog(triggerBtn){
    if(!importDialog) return;
    importDialogLastFocus = triggerBtn || document.activeElement;
    resetImportDialog();
    if(typeof importDialog.showModal==='function'){
      importDialog.removeAttribute('hidden');
      if(!importDialog.open) importDialog.showModal();
    }else{
      importDialog.setAttribute('open','');
      importDialog.removeAttribute('hidden');
    }
    requestAnimationFrame(()=>{ importTextarea?.focus(); });
  }

  function closeImportDialog(result){
    if(!importDialog) return;
    if(typeof importDialog.close==='function'){
      if(importDialog.open) importDialog.close(result||'close');
      else{
        resetImportDialog();
        const target=importDialogLastFocus;
        importDialogLastFocus=null;
        if(target && typeof target.focus==='function'){ target.focus(); }
      }
    }else{
      importDialog.removeAttribute('open');
      importDialog.setAttribute('hidden','');
      resetImportDialog();
      const target=importDialogLastFocus;
      importDialogLastFocus=null;
      if(target && typeof target.focus==='function'){ target.focus(); }
    }
  }

  if(importCancelBtn){
    importCancelBtn.addEventListener('click', ()=>{ closeImportDialog('cancel'); });
  }

  if(importForm){
    importForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      if(!importDialog || !importTextarea) return;
      const raw=importTextarea.value.trim();
      if(!raw){
        showImportError('Incolla del contenuto JSON prima di importare.');
        importTextarea.focus();
        return;
      }
      if(importError){
        importError.textContent='';
        importError.hidden=true;
      }
      importTextarea.removeAttribute('aria-invalid');
      let data;
      try{
        data=JSON.parse(raw);
      }catch(err){
        console.error(err);
        showImportError('Errore: JSON non valido.');
        importTextarea.focus();
        importTextarea.select();
        return;
      }
      try{
        ingestData(data);
        (window.announce||console.log)('Contenuti importati.');
        closeImportDialog('success');
      }catch(err){
        console.error(err);
        showImportError('Importazione non riuscita: verifica la struttura del JSON.');
        importTextarea.focus();
      }
    });
  }

  if(importDialog){
    importDialog.addEventListener('cancel', (e)=>{
      e.preventDefault();
      closeImportDialog('cancel');
    });
    importDialog.addEventListener('close', ()=>{
      resetImportDialog();
      importDialog.setAttribute('hidden','');
      const target=importDialogLastFocus;
      importDialogLastFocus=null;
      if(target && typeof target.focus==='function'){ target.focus(); }
    });
    if(typeof importDialog.showModal!=='function'){
      importDialog.addEventListener('keydown', (e)=>{
        if(e.key==='Escape'){
          e.preventDefault();
          closeImportDialog('cancel');
        }
      });
    }
  }

  window.openImportDialog=openImportDialog;
  window.closeImportDialog=closeImportDialog;

  // Fallback stubs (won't override your real ones)
  ensure('instrumentWords', NOP);
  ensure('annotateKeywordWords', NOP);
  ensure('buildGlossary', NOP);
  ensure('applyPrefs', NOP);
  ensure('renderQuizList', NOP);
  ensure('applySectionTitles', function(titles){
    if(!titles) return;
    const map = {
      attivazione:{section:'#attivazione>h2', toc:'#toc a[href="#attivazione"]'},
      primer:{section:'#primer>h2', toc:'#toc a[href="#primer"]'},
      percorso:{section:'#percorso>h2', toc:'#toc a[href="#percorso"]'},
      schema:{section:'#schema>h2', toc:'#toc a[href="#schema"]'},
      attivita:{section:'#attivita>h2', toc:'#toc a[href="#attivita"]'},
      quiz:{section:'#quiz>h2', toc:'#toc a[href="#quiz"]'},
      immagine:{section:'#immagine>h2', toc:'#toc a[href="#immagine"]'},
      glossario:{section:'#glossario>h2', toc:'#toc a[href="#glossario"]'},
      docente:{section:'#docente>h2', toc:'#toc a[href="#docente"]'}
    };
    for(const key in titles){
      const config = map[key];
      if(!config) continue;
      const newTitle = titles[key];

      const heading = document.querySelector(config.section);
      if(heading){
        const iconHTML = heading.querySelector('i')?.outerHTML || '';
        heading.innerHTML = iconHTML ? iconHTML + ' ' + newTitle : newTitle;
      }

      const tocLink = document.querySelector(config.toc);
      if(tocLink){
        let textNode = Array.from(tocLink.childNodes).find(node => node.nodeType === Node.TEXT_NODE && node.textContent.trim().length);
        const needsSpace = textNode
          ? (textNode.previousSibling && textNode.previousSibling.nodeType === Node.ELEMENT_NODE)
          : (tocLink.lastChild && tocLink.lastChild.nodeType === Node.ELEMENT_NODE);
        const value = (needsSpace ? ' ' : '') + newTitle;
        if(textNode){
          textNode.textContent = value;
        }else{
          tocLink.append(document.createTextNode(value));
        }
      }
    }
  });
  ensure('applyImage', function(img){
    const fig = document.querySelector('#immagine figure');
    const im = fig?.querySelector('img');
    const inlineHolder = fig?.querySelector('[data-role="inline-svg"]');
    const cap = fig?.querySelector('figcaption');
    const captionSpan = cap?.querySelector('[data-role="caption-text"]');
    const creditWrapper = cap?.querySelector('[data-role="credit-wrapper"]');
    const creditLink = cap?.querySelector('[data-role="credit-link"]');

    const src = typeof img.src === 'string' ? img.src.trim() : '';
    const hasSrc = Boolean(src);
    const altRaw = img.ALT || img.alt;
    const alt = (typeof altRaw === 'string' ? altRaw : '').trim();
    const inlineSvg = typeof img.inlineSvg === 'string' ? img.inlineSvg.trim() : '';
    const hasInline = inlineSvg.length > 0;
    const inlineAltRaw = typeof img.inlineAlt === 'string' ? img.inlineAlt : '';
    const inlineAlt = inlineAltRaw.trim();

    if(im){
      if(hasSrc){
        if(im.src !== src){ im.src = src; }
        im.hidden = false;
        im.removeAttribute('aria-hidden');
      }else{
        im.hidden = true;
        im.setAttribute('aria-hidden','true');
        if(im.hasAttribute('src')) im.removeAttribute('src');
      }
      if('loading' in im){ im.loading = img.loading || 'lazy'; }
      if(alt){
        im.alt = alt;
        im.title = alt;
      }
    }

    if(inlineHolder){
      inlineHolder.innerHTML = '';
      if(hasInline){
        inlineHolder.innerHTML = inlineSvg;
        inlineHolder.hidden = false;
        inlineHolder.removeAttribute('aria-hidden');
        inlineHolder.setAttribute('role','img');
        const label = inlineAlt || alt || 'Illustrazione vettoriale';
        inlineHolder.setAttribute('aria-label', label);
      }else{
        inlineHolder.hidden = true;
        inlineHolder.setAttribute('aria-hidden','true');
        inlineHolder.removeAttribute('role');
        inlineHolder.removeAttribute('aria-label');
      }
    }

    if(fig){
      const isSvg = /\.svg(\?|#|$)/i.test(src) || /^data:image\/svg\+xml/i.test(src);
      fig.classList.toggle('is-svg', Boolean(isSvg || hasInline));
      if(hasInline){
        fig.dataset.hasInlineSvg = 'true';
      }else{
        fig.removeAttribute('data-has-inline-svg');
      }
    }

    if(captionSpan){
      if(typeof img.caption === 'string' && img.caption.trim()){
        captionSpan.textContent = img.caption.trim();
        captionSpan.hidden = false;
      }else{
        captionSpan.textContent = '';
        captionSpan.hidden = true;
      }
    }else if(cap && typeof img.caption === 'string' && img.caption.trim()){
      const text = img.caption.trim() + ' ';
      if(cap.firstChild && cap.firstChild.nodeType === Node.TEXT_NODE){
        cap.firstChild.nodeValue = text;
      }else{
        cap.insertBefore(document.createTextNode(text), cap.firstChild || null);
      }
    }

    const hasCreditUrl = typeof img.creditUrl === 'string' && img.creditUrl.trim();
    const creditUrl = hasCreditUrl ? img.creditUrl.trim() : '';
    if(creditLink){
      if(hasCreditUrl){
        creditLink.href = creditUrl;
        creditLink.textContent = (img.creditLabel && img.creditLabel.trim()) || creditUrl;
        creditLink.target = '_blank';
        creditLink.rel = 'noopener';
        creditLink.hidden = false;
        if(creditWrapper){ creditWrapper.hidden = false; }
      }else{
        creditLink.removeAttribute('href');
        creditLink.removeAttribute('target');
        creditLink.removeAttribute('rel');
        creditLink.hidden = true;
        if(creditWrapper){ creditWrapper.hidden = true; }
      }
    }else if(cap && hasCreditUrl){
      const wrapper = creditWrapper || document.createElement('span');
      wrapper.dataset.role = wrapper.dataset.role || 'credit-wrapper';
      if(!creditWrapper){
        wrapper.setAttribute('data-role','credit-wrapper');
        wrapper.textContent = 'Fonte: ';
        cap.appendChild(wrapper);
      }
      const link = document.createElement('a');
      link.setAttribute('data-role','credit-link');
      link.href = creditUrl;
      link.target = '_blank';
      link.rel = 'noopener';
      link.textContent = (img.creditLabel && img.creditLabel.trim()) || creditUrl;
      wrapper.appendChild(link);
      if(wrapper.hidden) wrapper.hidden = false;
    }
  });
  ensure('applyMermaid', function(diagram){
    const el = document.getElementById('mermaidMap');
    if(!el) return;
    el.textContent = diagram || '';
    if(window.mermaid){
      try{
        el.removeAttribute('data-processed');
        mermaid.run({nodes:[el]});
      }catch(e){ console.warn(e); }
    }
  });
  ensure('applyGlossary', function(entries){
    if(!Array.isArray(entries)||!entries.length) return;
    const dl = document.querySelector('#glossario dl'); if(!dl) return;
    dl.innerHTML='';
    entries.forEach(({term,def})=>{
      const dt=document.createElement('dt'); dt.innerHTML='<strong>'+escapeHTML(term)+'</strong>';
      const dd=document.createElement('dd'); dd.textContent=def;
      dl.appendChild(dt); dl.appendChild(dd);
    });
  });
  ensure('escapeHTML', function(s){
    const map={"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"};
    return String(s).replace(/[&<>"']/g, m=>map[m]);
  });

  // --- Placeholders globali su tutta la pagina ---
  function makeKeyRegex(key){
    const escaped=key.replace(/[.*+?^${}()|[\\]\\\\]/g,'\\$&');
    return new RegExp('\\['+ escaped +'(?::[^\\]]*)?\\]','g');
  }
  function escapeForJsLiteral(value){
    if(value===null || value===undefined) return null;
    try{
      const jsonEncoded=JSON.stringify(String(value));
      const withoutQuotes=jsonEncoded.slice(1,-1);
      return withoutQuotes.replace(/[\'`]/g, ch=>'\\'+ch);
    }catch(_){
      const raw=String(value);
      const replacements={"\\":"\\\\","\"":"\\\"","'":"\\'","`":"\\`","\n":"\\n","\r":"\\r","\u2028":"\\u2028","\u2029":"\\u2029"};
      return raw.replace(/[\\"'`\n\r\u2028\u2029]/g, ch=>replacements[ch]||ch);
    }
  }
  function replaceInString(str,map){ if(typeof str!=='string') return str; let out=str; for(const k of Object.keys(map)){ out=out.replace(makeKeyRegex(k), String(map[k])); } return out; }

  const ALLOWED_HTML_TAGS=new Set(['BR','STRONG','EM','B','I','U','MARK','SMALL','SUP','SUB','UL','OL','LI','P','SPAN','A']);
  const ALLOWED_GLOBAL_ATTRS=new Set(['title']);
  const ALLOWED_ATTRS_BY_TAG={
    A:new Set(['href','title','target','rel'])
  };
  function isSafeHref(url){
    if(typeof url!=='string') return false;
    const trimmed=url.trim();
    if(!trimmed) return false;
    const lower=trimmed.toLowerCase();
    if(lower.startsWith('javascript:')||lower.startsWith('data:')||lower.startsWith('vbscript:')) return false;
    return true;
  }
  function sanitizeAllowedHTML(html){
    const template=document.createElement('template');
    template.innerHTML=html;
    const elements=template.content.querySelectorAll('*');
    elements.forEach(el=>{
      const tag=el.tagName;
      if(!ALLOWED_HTML_TAGS.has(tag)){
        el.replaceWith(...Array.from(el.childNodes));
        return;
      }
      Array.from(el.attributes).forEach(attr=>{
        const name=attr.name.toLowerCase();
        if(name.startsWith('on')){
          el.removeAttribute(attr.name);
          return;
        }
        if(ALLOWED_GLOBAL_ATTRS.has(name) || (ALLOWED_ATTRS_BY_TAG[tag]?.has(name))){
          if(tag==='A' && name==='href' && !isSafeHref(attr.value)){
            el.removeAttribute(attr.name);
            return;
          }
          if(tag==='A' && name==='href'){
            if(!el.hasAttribute('rel')) el.setAttribute('rel','noopener');
            if(!el.hasAttribute('target')) el.setAttribute('target','_blank');
          }
        }else{
          el.removeAttribute(attr.name);
        }
      });
    });
    return template.innerHTML;
  }

  function applyGlobalPlaceholders(map){
    if(!map || !Object.keys(map).length) return;
    if(document.title) document.title = replaceInString(document.title, map);
    const metaDesc=document.querySelector('meta[name="description"]');
    if(metaDesc?.content) metaDesc.content = replaceInString(metaDesc.content, map);

    const ATTRS=['title','alt','aria-label','placeholder','value','role'];
    const walker=document.createTreeWalker(document.documentElement, NodeFilter.SHOW_ELEMENT|NodeFilter.SHOW_TEXT, {
      acceptNode(node){
        if(node.nodeType===Node.ELEMENT_NODE){
          const t=node.tagName;
          if(t==='SCRIPT'||t==='STYLE') return NodeFilter.FILTER_REJECT;
        }
        return NodeFilter.FILTER_ACCEPT;
      }
    });
    const textNodes=[];
    const elementNodes=[];
    let cursor=walker.currentNode;
    while(cursor){
      if(cursor.nodeType===Node.TEXT_NODE){
        textNodes.push(cursor);
      }else if(cursor.nodeType===Node.ELEMENT_NODE){
        elementNodes.push(cursor);
      }
      cursor=walker.nextNode();
    }

    textNodes.forEach(node=>{
      if(!node.isConnected) return;
      const original=node.nodeValue;
      const replaced=replaceInString(original, map);
      if(replaced===original) return;
      if(/<\/?[a-zA-Z]/.test(replaced)){
        const parent=node.parentNode;
        if(!parent){
          node.nodeValue=replaced;
          return;
        }
        const sanitized=sanitizeAllowedHTML(replaced);
        const range=document.createRange();
        range.selectNode(parent);
        const fragment=range.createContextualFragment(sanitized);
        parent.replaceChild(fragment, node);
        range.detach?.();
      }else{
        node.nodeValue=replaced;
      }
    });

    elementNodes.forEach(el=>{
      if(!el.isConnected) return;
      for(const a of ATTRS){
        if(el.hasAttribute(a)){
          const v=el.getAttribute(a);
          const nv=replaceInString(v, map);
          if(nv!==v) el.setAttribute(a,nv);
        }
      }
      Array.from(el.attributes).forEach(({name,value})=>{
        if(name.startsWith('data-')){
          const nv=replaceInString(value,map);
          if(nv!==value) el.setAttribute(name,nv);
        }
      });
    });

    call('instrumentWords', content);
    call('annotateKeywordWords');
    call('buildGlossary');
    call('applyPrefs');
    call('renderQuizList');
    if(window.mermaid){ try{ mermaid.run(); }catch(_){} }
  }

  // --- Ingestione dati comune ---
  function ingestData(data){
    if(data && typeof data==='object'){
      try{
        lastIngestedData = typeof structuredClone==='function'
          ? structuredClone(data)
          : JSON.parse(JSON.stringify(data));
      }catch(err){
        console.warn('Impossibile clonare i dati importati in modo profondo.', err);
        try{ lastIngestedData = JSON.parse(JSON.stringify(data)); }
        catch(_){ lastIngestedData = data; }
      }
    }else{
      lastIngestedData=null;
    }
    const payload=(data && typeof data==='object') ? data : {};
    const ph=payload.placeholders||{};
    applyGlobalPlaceholders(ph);
    call('applySectionTitles', payload.sectionTitles||null);
    if(payload.image){
      const img=Object.assign({}, payload.image);
      if(!img.ALT && ph?.ALT_IMMAGINE) img.ALT=ph.ALT_IMMAGINE;
      if(!img.caption && ph?.DIDASCALIA_IMMAGINE) img.caption=ph.DIDASCALIA_IMMAGINE;
      call('applyImage', img);
    }
    if(payload.mermaid) call('applyMermaid', payload.mermaid);
    if(Array.isArray(payload.glossario)) call('applyGlossary', payload.glossario);
    if(Array.isArray(payload.quiz)){
      quizData.length=0;
      payload.quiz.forEach(q=>quizData.push({q:q.q,choices:q.choices,correct:q.correct,hint:q.hint||'',explain:q.explain||''}));
      call('renderQuizList');
      if(quizData.length>0){
        const nextIndex = (qi>=0 && qi<quizData.length) ? qi : 0;
        quizIntroSpoken=false;
        attempts=0;
        if(btnNext) btnNext.disabled=true;
        if(btnHint) btnHint.style.display='none';
        if(btnShowSolution) btnShowSolution.style.display='none';
        resetQuizFeedback();
        if(typeof announce==='function'){ announce(`Domanda ${nextIndex+1}/${quizData.length}`); }
        setActiveQuestion(nextIndex);
      }else{
        qi=0;
        attempts=0;
        resetQuizFeedback();
        if(btnNext) btnNext.disabled=true;
        if(btnHint) btnHint.style.display='none';
        if(btnShowSolution) btnShowSolution.style.display='none';
      }
    }
    initGuidedTask();
  }
  ensure('ingestData', ingestData);
  if(typeof window!=='undefined') window.ingestData=ingestData;

  initGuidedTask();

  // --- Toolbar: aggiungi pulsanti Import/Incolla/Export in modo non intrusivo ---
  function ensureToolbarButtons(){
    const toolbar = document.querySelector('.toolbar, [role="toolbar"], #toolbar');
    if(!toolbar) return;

    const settingsBtn=document.getElementById('tbSettings');
    const settingsMenu=document.getElementById('tbSettingsMenu');
    const importBtn=document.getElementById('tbImport');
    const pasteBtn=document.getElementById('tbPasteImport');
    const exportBtn=document.getElementById('tbExport');
    const downloadBtn=document.getElementById('tbDownloadTemplate');
    const svgDemoBtn=document.getElementById('tbDownloadSvgDemo');
    const file=document.getElementById('contentFile') || (function(){ const i=document.createElement('input'); i.type='file'; i.accept='.json,application/json'; i.id='contentFile'; i.hidden=true; document.body.appendChild(i); return i; })();

    if(!settingsBtn || !settingsMenu) return;
    if(ensureToolbarButtons._initialized) return;
    ensureToolbarButtons._initialized=true;

    settingsBtn.setAttribute('aria-haspopup','true');
    settingsBtn.setAttribute('aria-expanded','false');
    settingsBtn.setAttribute('aria-controls', settingsMenu.id);
    settingsMenu.setAttribute('aria-labelledby', settingsBtn.id);

    const menuState={open:false};
    const openMenu=()=>{
      if(menuState.open) return;
      menuState.open=true;
      settingsMenu.hidden=false;
      settingsMenu.dataset.open='true';
      settingsBtn.setAttribute('aria-expanded','true');
      if(document.activeElement===settingsBtn){
        const first=settingsMenu.querySelector('button');
        if(first){ requestAnimationFrame(()=>first.focus()); }
      }
    };
    const closeMenu=(focusBack=false)=>{
      if(!menuState.open) return;
      menuState.open=false;
      settingsMenu.hidden=true;
      settingsMenu.dataset.open='false';
      settingsBtn.setAttribute('aria-expanded','false');
      if(focusBack){ settingsBtn.focus(); }
    };

    settingsBtn.addEventListener('click', (event)=>{
      event.preventDefault();
      event.stopPropagation();
      if(menuState.open){
        closeMenu(true);
      }else{
        openMenu();
      }
    });

    settingsBtn.addEventListener('keydown', (event)=>{
      if((event.key==='ArrowDown' || event.key==='Enter' || event.key===' ') && !menuState.open){
        event.preventDefault();
        openMenu();
      }else if(event.key==='Escape' && menuState.open){
        event.preventDefault();
        closeMenu(true);
      }
    });

    const onDocumentClick=(event)=>{
      if(!menuState.open) return;
      if(settingsMenu.contains(event.target) || settingsBtn.contains(event.target)) return;
      closeMenu();
    };
    document.addEventListener('click', onDocumentClick);
    document.addEventListener('keydown', (event)=>{
      if(event.key==='Escape' && menuState.open){
        event.preventDefault();
        closeMenu(true);
      }
    });
    settingsMenu.addEventListener('click', (event)=>event.stopPropagation());
    settingsMenu.addEventListener('keydown', (event)=>{
      if(event.key==='Escape'){
        event.preventDefault();
        closeMenu(true);
      }
    });

    importBtn?.addEventListener('click', (event)=>{
      event.preventDefault();
      if(file){ file.click(); }
      closeMenu(true);
    });

    if(file && !file.dataset.listenerAttached){
      file.addEventListener('change', async (e)=>{
        const f=e.target.files?.[0]; if(!f) return;
        try{
          const data = JSON.parse(await f.text());
          ingestData(data);
          (window.announce||console.log)('Contenuti importati.');
        }catch(err){ console.error(err); alert('Errore: JSON non valido.'); }
        finally{ e.target.value=''; }
      });
      file.dataset.listenerAttached='true';
    }

    pasteBtn?.addEventListener('click', (event)=>{
      event.preventDefault();
      if(typeof openImportDialog==='function'){
        openImportDialog(pasteBtn);
      }
      closeMenu(true);
    });

    exportBtn?.addEventListener('click', (event)=>{
      event.preventDefault();
      closeMenu(true);
      const clonedRoot=document.documentElement.cloneNode(true);

      if(lastIngestedData){
        const placeholders=lastIngestedData.placeholders||{};
        const scriptCloseRe=new RegExp('</'+'script>','gi');
        const scripts=Array.from(clonedRoot.querySelectorAll('script'));
        if(Object.keys(placeholders).length){
          const scriptSafePlaceholders={};
          for(const [key,value] of Object.entries(placeholders)){
            const escaped=escapeForJsLiteral(value);
            if(typeof escaped==='string'){
              scriptSafePlaceholders[key]=escaped;
            }
          }
          if(Object.keys(scriptSafePlaceholders).length){
            scripts.forEach(scr=>{
              if(scr.textContent){
                scr.textContent=replaceInString(scr.textContent, scriptSafePlaceholders);
              }
            });
          }
        }

        if(Array.isArray(lastIngestedData.quiz) && lastIngestedData.quiz.length){
          const quizScript=scripts.find(scr=>scr.textContent && scr.textContent.includes('const quizData='));
          if(quizScript){
            const quizJson=JSON.stringify(lastIngestedData.quiz, null, 2).replace(scriptCloseRe,'<\\/script>');
            quizScript.textContent = quizScript.textContent.replace(/const\s+quizData\s*=\s*\[[\s\S]*?\];/, `const quizData=${quizJson};`);
          }
        }

        const bodyClone=clonedRoot.querySelector('body');
        if(bodyClone){
          const dataJson=JSON.stringify(lastIngestedData).replace(scriptCloseRe,'<\\/script>');
          const bootstrap=document.createElement('script');
          bootstrap.type='text/javascript';
          bootstrap.textContent=`(function(){
  window.__EXPORTED_DATA__ = ${dataJson};
  window.addEventListener('DOMContentLoaded', function(){
    try{
      if(window.__EXPORTED_DATA__ && typeof window.ingestData==='function'){
        window.ingestData(window.__EXPORTED_DATA__);
      }
    }catch(err){
      console.error('Ripristino dati esportati fallito', err);
    }
  }, {once:true});
})();`;
          bodyClone.appendChild(bootstrap);
        }
      }

      const html = '<!DOCTYPE html>' + clonedRoot.outerHTML;
      const blob = new Blob([html], {type:'text/html;charset=utf-8'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download=(document.title||'lezione')+'.html';
      document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); },0);
    });

    if(downloadBtn){ downloadBtn.dataset.bindDownload='true'; }
    if(svgDemoBtn){ svgDemoBtn.dataset.bindDownload='true'; }

    downloadBtn?.addEventListener('click', async (event)=>{
      event.preventDefault();
      closeMenu(true);
      try{
        const response=await fetch('demo-contenuti-emozioni.json', {cache:'no-store'});
        if(!response.ok) throw new Error('HTTP '+response.status);
        const blob=await response.blob();
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a');
        a.href=url;
        a.download='modello-contenuti.json';
        document.body.appendChild(a); a.click();
        setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); },0);
      }catch(err){
        console.error('Scarica modello JSON fallito', err);
        alert('Impossibile scaricare il modello JSON.');
      }
    });

    svgDemoBtn?.addEventListener('click', async (event)=>{
      event.preventDefault();
      closeMenu(true);
      try{
        const response=await fetch('demo-contenuti-svg.json', {cache:'no-store'});
        if(!response.ok) throw new Error('HTTP '+response.status);
        const blob=await response.blob();
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a');
        a.href=url;
        a.download='demo-contenuti-svg.json';
        document.body.appendChild(a); a.click();
        setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); },0);
      }catch(err){
        console.error('Scarica demo SVG fallito', err);
        alert('Impossibile scaricare il demo SVG.');
      }
    });
  }

  document.addEventListener('DOMContentLoaded', ensureToolbarButtons);
  function setupStaticDownloadTrigger(id, href, filename, fallbackTitle){
    document.addEventListener('DOMContentLoaded', function(){
      const trigger=document.getElementById(id);
      if(!trigger || trigger.dataset.bindDownload==='true') return;
      trigger.dataset.bindDownload='true';
      if(fallbackTitle && !trigger.getAttribute('title')){
        trigger.setAttribute('title', fallbackTitle);
      }
      if(trigger.tagName==='A'){
        trigger.setAttribute('href', href);
        trigger.setAttribute('download', filename);
      }else{
        trigger.addEventListener('click', function(){
          const link=document.createElement('a');
          link.href=href;
          link.download=filename;
          link.hidden=true;
          document.body.appendChild(link);
          link.click();
          setTimeout(()=>link.remove(),0);
        });
      }
    });
  }
  setupStaticDownloadTrigger('tbDownloadTemplate','modello-import.json','modello-import.json','[TOOLTIP_MODELLO]');
  setupStaticDownloadTrigger('tbDownloadSvgDemo','demo-contenuti-svg.json','demo-contenuti-svg.json','[TOOLTIP_SCARICA_DEMO_SVG]');
})();
</script>
<!-- ==== /UPGRADE PACK ==== -->
<input id="contentFile" type="file" accept=".json,application/json" hidden>

</body>
</html>
